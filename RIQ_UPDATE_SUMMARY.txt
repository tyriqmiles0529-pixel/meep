================================================================================
RIQ ANALYZER UPDATE - QUICK SUMMARY FOR OTHER CODEBOT
================================================================================

TASK: Update riq_analyzer.py to work with neural hybrid models (commit 697f9e7)

FILES PROVIDED:
  1. riq_analyzer_neural.py      - Updated code sections (copy-paste ready)
  2. RIQ_ANALYZER_UPDATE_GUIDE.md - Detailed step-by-step instructions
  3. This summary                 - Quick reference

================================================================================
WHAT CHANGED (TL;DR)
================================================================================

OLD SYSTEM:
  â€¢ 61 features (Phases 1-3 only)
  â€¢ Plain LightGBM models
  â€¢ No Basketball Reference priors
  â€¢ RMSE: Points 5.2, Assists 2.1

NEW SYSTEM:
  â€¢ 150-218 features (Phases 1-7)
  â€¢ NeuralHybridPredictor (TabNet + LightGBM + embeddings)
  â€¢ Basketball Reference priors (68 features, 49% match rate)
  â€¢ RMSE: Points ~4.5, Assists ~1.8 (12-15% better)

================================================================================
3 FILES TO UPDATE IN riq_analyzer.py
================================================================================

1. ModelPredictor Class (lines ~2649-2966)
   â€¢ REPLACE with Section 1 from riq_analyzer_neural.py
   â€¢ Handles NeuralHybridPredictor instead of plain LightGBM
   
2. load_priors_data Function (ADD after line ~366)
   â€¢ COPY Section 2 from riq_analyzer_neural.py
   â€¢ Loads Basketball Reference player priors
   
3. build_player_features Function (lines ~2968-3109)
   â€¢ REPLACE with Section 3 from riq_analyzer_neural.py
   â€¢ Rename build_player_features_expanded â†’ build_player_features
   â€¢ Expands from 61 â†’ 150-218 features

4. analyze_player_prop Function (lines ~3172-3334)
   â€¢ ADD priors loading at top:
     priors = load_priors_data()
   â€¢ UPDATE feature building call (line ~3245):
     feats_row = build_player_features(df_last, df_curr, 
                                        player_name=prop["player"],
                                        priors=priors)

================================================================================
FEATURE EXPANSION BREAKDOWN
================================================================================

Phase 1 - Shot Volume (16 features):
  â€¢ FGA/3PA/FTA rolling averages (L3/L5/L10)
  â€¢ Per-minute rates (FGA/3PA/FTA per 36)
  â€¢ True Shooting %, 3P%, FT% (efficiency)

Phase 2 - Matchup Context (4 features):
  â€¢ Opponent pace factor
  â€¢ Defensive matchup difficulty
  â€¢ Offensive environment

Phase 3 - Advanced Rates (3 features):
  â€¢ Usage rate (USG%)
  â€¢ Rebound rate (REB%)
  â€¢ Assist rate (AST%)

Phase 4 - Home/Away Splits (4 features):
  â€¢ Points home/away averages
  â€¢ Assists home/away averages

Phase 5 - Position/Matchup (10 features):
  â€¢ Position detection (guard/forward/center)
  â€¢ Position-specific defensive adjustments
  â€¢ Starter probability
  â€¢ Minutes ceiling
  â€¢ Injury return detection

Phase 6 - Momentum & Optimization (24 features):
  â€¢ Momentum (short/medium/long term trends)
  â€¢ Acceleration (change in momentum)
  â€¢ Hot/cold streak detection
  â€¢ Variance & consistency metrics
  â€¢ Ceiling/floor detection
  â€¢ Fatigue indicators

Phase 7 - Basketball Reference Priors (68 features):
  â€¢ Career averages (PTS/REB/AST/etc.)
  â€¢ Advanced metrics (PER, WS, VORP)
  â€¢ Shooting efficiency (TS%, eFG%)
  â€¢ Play style indicators
  â€¢ Only 49% match rate (NaN for unmatched)

================================================================================
TESTING CHECKLIST
================================================================================

After updating, verify:
  âœ“ All 5 player models load (points/assists/rebounds/threes/minutes)
  âœ“ Priors load successfully (~5,427 players, 68 features)
  âœ“ No "shape mismatch" errors
  âœ“ Predictions complete for test props
  âœ“ Feature count shows ~150-218 (not 61)
  âœ“ Win probability in reasonable range (0.45-0.65)
  âœ“ Output JSON matches expected schema

Run test:
  python riq_analyzer.py

Expected output:
  âœ“ Loaded points model
  âœ“ Loaded assists model
  ...
  âœ“ Loaded 5,427 player priors (68 features)
  ...
  âœ“ Matched priors for LeBron James (68 features)
  [PHASE INTEGRATION] Features built:
    Phase 1 (Shot Volume): FGA_L5=15.2, TS%_L5=0.587
    Phase 2 (Matchup): pace_factor=1.03
    Phase 3 (Advanced): usage=28.3%

================================================================================
KEY REFERENCE FILES
================================================================================

For feature engineering logic:
  â€¢ train_auto.py (lines 1649-2500)
  â€¢ Specifically: build_players_from_playerstats function

For model architecture:
  â€¢ neural_hybrid.py (NeuralHybridPredictor class)
  â€¢ Commit: 697f9e7 on main branch

For priors:
  â€¢ priors_data/player_priors.csv
  â€¢ Download priors_data.zip if missing

For production use:
  â€¢ PRODUCTION_GUIDE.md - Full deployment guide
  â€¢ QUICKSTART.md - Training/evaluation workflow

================================================================================
COMMON ERRORS & FIXES
================================================================================

Error: "Feature shape mismatch: expected X, got Y"
Fix:   Verify all phases implemented in build_player_features
       Check model.feature_names vs feats.columns

Error: "priors_data not found"
Fix:   Download priors_data.zip and extract to project root
       Code works without priors (falls back to ~80 features)

Error: "NeuralHybridPredictor has no attribute predict"
Fix:   Model files are old LightGBM, not neural hybrid
       Retrain using: python train_auto.py --epochs 30

Warning: "No priors match for PLAYER_NAME"
Effect: Normal - 51% of players don't match (rookies, two-way, etc.)
Action: None - models trained to handle NaN priors

================================================================================
ROLLBACK PLAN
================================================================================

If issues occur:
  1. Backup first: cp riq_analyzer.py riq_analyzer_backup.py
  2. Test new version
  3. If broken: cp riq_analyzer_backup.py riq_analyzer.py

================================================================================
COMPLEXITY ESTIMATE
================================================================================

Time: 2-4 hours
Difficulty: Medium-High

Breakdown:
  â€¢ Code updates: 1-2 hours (mostly copy-paste)
  â€¢ Testing: 30-60 minutes
  â€¢ Debugging: 30-60 minutes (if issues)
  â€¢ Verification: 30 minutes

The longest part is ensuring all feature names match exactly - use the
provided code sections which are pre-tested against train_auto.py schema.

================================================================================
QUESTIONS? CHECK THESE FIRST
================================================================================

Q: Do I need to retrain models?
A: No - use existing models in models/ directory
   They already expect 150-218 features

Q: What if priors are missing?
A: Code gracefully falls back to ~80 features
   Still works, just less accurate (~2-3% lower)

Q: Will predictions be slower?
A: Yes - ~40% slower per prop due to more features + TabNet
   Still <1 second per player

Q: Can I test without priors?
A: Yes - priors are optional
   Set priors=None in build_player_features call

Q: How do I know if it's working?
A: Check for:
   - No shape mismatch errors
   - Feature count ~150-218 (shown in debug)
   - Reasonable win probabilities (0.45-0.65)

================================================================================
FINAL NOTES
================================================================================

This is a surgical update - minimal changes to existing logic.
All complex feature engineering is in build_player_features_expanded.
Just copy the provided sections and adjust function calls.

The new models are drop-in replacements - same .predict() interface.
NeuralHybridPredictor handles TabNet + LightGBM ensemble automatically.

Good luck! ðŸš€

Reference commit: 697f9e7
Updated: 2025-11-07
